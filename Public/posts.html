<script>
const currentUser = getCurrentUser();
const userDisplay = document.getElementById("userDisplay");
const logoutBtn = document.getElementById("logoutBtn");
const signInBtn = document.getElementById("signInBtn");
const signUpBtn = document.getElementById("signUpBtn");
const myAccountBtn = document.getElementById("myAccountBtn");

if(currentUser){
  userDisplay.textContent = currentUser;
  logoutBtn.style.display="inline-block";
  myAccountBtn.style.display="inline-block";
  signInBtn.style.display="none";
  signUpBtn.style.display="none";
  myAccountBtn.href="account.html?mode=account";
} else {
  const returnURL = window.location.href;
  signInBtn.href = `account.html?mode=login&return=${encodeURIComponent(returnURL)}`;
  signUpBtn.href = `account.html?mode=signup&return=${encodeURIComponent(returnURL)}`;
}

logoutBtn.addEventListener("click",()=>{ logout(); window.location.reload(); });

const postsList = document.getElementById("postsList");
const addPostBtn = document.getElementById("addPostBtn");
const postTitle = document.getElementById("postTitle");
const postDescription = document.getElementById("postDescription");
const postImageFile = document.getElementById("postImageFile");

// --- Fetch helpers ---

async function getPosts() {
  const res = await fetch('http://localhost:3000/posts');
  return await res.json();
}

async function addPost(post) {
  const res = await fetch('http://localhost:3000/posts', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(post)
  });
  return await res.json();
}

async function editPostDB(id, update){
  const posts = await getPosts();
  const post = posts.find(p => p.id === id);
  if(!post) return;
  post.title = update.title;
  post.description = update.description;

  await fetch('http://localhost:3000/posts', {
    method: 'PUT',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(post)
  });
}

async function deletePostDB(id){
  await fetch(`http://localhost:3000/posts/${id}`, { method:'DELETE' });
}

// --- Render posts ---
async function renderPosts(filter=""){
  postsList.innerHTML="";
  const posts = await getPosts();
  posts
    .filter(p => p.title.toLowerCase().includes(filter.toLowerCase()) || p.description.toLowerCase().includes(filter.toLowerCase()))
    .forEach((p,i)=>{
      const div = document.createElement("div");
      div.className="post";
      div.innerHTML=`<h4>${p.title}</h4>
                     <p>${p.description}</p>
                     <p>by ${p.user}</p>
                     ${p.image ? `<img src="${p.image}">` : ''}`;

      if(p.user === currentUser){
        const editBtn = document.createElement("button");
        editBtn.textContent = "Edit";
        editBtn.className="edit-btn";
        editBtn.addEventListener("click",()=>editPost(i,p.id));
        div.appendChild(editBtn);
      }

      if(currentUser==="itsmehaman"){ 
        const deleteBtn = document.createElement("button");
        deleteBtn.textContent="Delete";
        deleteBtn.className="delete-btn";
        deleteBtn.addEventListener("click",()=>deletePost(p.id));
        div.appendChild(deleteBtn);
      }

      postsList.appendChild(div);
    });
}

renderPosts();

// --- Add new post ---
addPostBtn.addEventListener("click", async ()=>{
  if(!currentUser){ alert("Sign in to post."); return; }
  const title = postTitle.value.trim();
  const description = postDescription.value.trim();
  const file = postImageFile.files[0];
  if(!title || !file){ alert("Title + Image required."); return; }

  const reader = new FileReader();
  reader.onload = async function(e){
    await addPost({title, description, user:currentUser, image:e.target.result});
    postTitle.value=""; postDescription.value=""; postImageFile.value="";
    await renderPosts();
  }
  reader.readAsDataURL(file);
});

// --- Edit post ---
async function editPost(index,id){
  const posts = await getPosts();
  const post = posts[index];
  const newTitle = prompt("Edit title:", post.title);
  const newDescription = prompt("Edit description:", post.description);
  if(newTitle!==null && newDescription!==null){
    await editPostDB(id,{title:newTitle, description:newDescription});
    await renderPosts();
  }
}

// --- Delete post ---
async function deletePost(id){
  if(confirm("Delete this post?")){
    await deletePostDB(id);
    await renderPosts();
  }
}

// --- Search ---
document.getElementById("searchInput").addEventListener("input", e=>{
  renderPosts(e.target.value);
});
</script>

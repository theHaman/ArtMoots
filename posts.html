<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ArtMoots - Posts</title>
<style>
:root {
  --bg: #f9f9f9;
  --text: #222;
  --border: #ddd;
  --accent: #111;
  --max-width: 900px;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: "Segoe UI", Arial, sans-serif; background: var(--bg); color: var(--text); display: flex; flex-direction: column; min-height: 100vh; }

header { background: white; border-bottom: 1px solid var(--border); padding: 1rem 0; }
.header-container { max-width: var(--max-width); margin: 0 auto; display: flex; justify-content: space-between; align-items: center; padding: 0 1rem; }
.logo { font-size: 1.4rem; font-weight: bold; }
nav a, #userDisplay { margin-left: 1rem; text-decoration: none; color: var(--text); font-weight: 500; padding: 0.4rem 0.6rem; border-radius: 4px; }
nav a:hover { background: #eee; }

main { flex: 1; max-width: var(--max-width); margin: 2rem auto; padding: 0 1rem; }

.post-form { background: white; border: 1px solid var(--border); padding: 1rem; border-radius: 6px; margin-bottom: 2rem; }
.post-form input, .post-form textarea { width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px; margin-bottom: 0.8rem; }
.post-form button { background: var(--accent); color: white; border: none; padding: 0.6rem 1.2rem; border-radius: 4px; cursor: pointer; }
.post-form button:hover { background: #333; }

.posts-container { display: flex; flex-direction: column; gap: 1rem; }
.post-item { background: white; border: 1px solid var(--border); padding: 1rem; border-radius: 6px; }
.post-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
.post-header h3 { margin: 0; }
.post-header span { font-size: 0.9rem; color: #666; }
.post-item img { width: 100%; max-height: 300px; object-fit: cover; border-radius: 6px; margin: 0.5rem 0; }
.post-actions { display: flex; gap: 1rem; margin-top: 0.5rem; }
button.like-btn, button.delete-btn { border: 1px solid var(--border); background: #f5f5f5; padding: 0.4rem 0.8rem; border-radius: 4px; cursor: pointer; }
button.like-btn.liked { color: red; font-weight: bold; }
</style>
</head>
<body>

<header>
  <div class="header-container">
    <div class="logo">ArtMoots</div>
    <nav>
      <a href="index.html">Home</a>
      <a href="posts.html">Posts</a>
      <a href="moots.html">Moots</a>
      <span id="userDisplay"></span>
      <a class="btn" id="myAccountBtn" href="#" style="display:none;">My Account</a>
      <a class="btn" id="signInBtn" href="#">Sign In</a>
      <a class="btn" id="signUpBtn" href="#">Sign Up</a>
      <a class="btn" id="logoutBtn" href="#" style="display:none;">Logout</a>
    </nav>
  </div>
</header>

<main>
  <div class="post-form" id="postFormContainer" style="display:none;">
    <h2>Create a Post</h2>
    <input type="text" id="postTitle" placeholder="Post title" required>
    <textarea id="postDescription" placeholder="Description" rows="3" required></textarea>
    <input type="file" id="postImage" accept="image/*">
    <button id="submitPost">Post</button>
  </div>

  <div class="posts-container" id="postsContainer"></div>
</main>

<script src="accounts-database.js"></script>
<script src="posts-database.js"></script>
<script>
// Header
const currentUser = getCurrentUser();
const userDisplay = document.getElementById("userDisplay");
const myAccountBtn = document.getElementById("myAccountBtn");
const logoutBtn = document.getElementById("logoutBtn");
const signInBtn = document.getElementById("signInBtn");
const signUpBtn = document.getElementById("signUpBtn");
const postFormContainer = document.getElementById("postFormContainer");

if(currentUser){
  userDisplay.textContent = currentUser;
  myAccountBtn.style.display = "inline-block";
  logoutBtn.style.display = "inline-block";
  signInBtn.style.display = "none";
  signUpBtn.style.display = "none";
  postFormContainer.style.display = "block";
  myAccountBtn.href = "account.html?mode=account";
} else {
  const returnURL = window.location.href;
  signInBtn.href = `account.html?mode=login&return=${encodeURIComponent(returnURL)}`;
  signUpBtn.href = `account.html?mode=signup&return=${encodeURIComponent(returnURL)}`;
}

logoutBtn.addEventListener("click",()=>{
  logout();
  window.location.reload();
});

// Posts
const postsContainer = document.getElementById("postsContainer");
const submitPost = document.getElementById("submitPost");
const postTitle = document.getElementById("postTitle");
const postDescription = document.getElementById("postDescription");
const postImage = document.getElementById("postImage");

function renderPosts(){
  const posts = getPosts().sort((a,b)=>new Date(b.date)-new Date(a.date));
  postsContainer.innerHTML = "";
  if(posts.length === 0){
    postsContainer.innerHTML = "<p>No posts yet.</p>";
    return;
  }
  posts.forEach(post=>{
    const postDiv = document.createElement("div");
    postDiv.className = "post-item";
    const isOwner = currentUser && currentUser === post.username;
    const isLiked = currentUser && post.likes && post.likes.includes(currentUser);
    postDiv.innerHTML = `
      <div class="post-header">
        <h3>${post.title}</h3>
        <span>by ${post.username}</span>
      </div>
      ${post.image ? `<img src="${post.image}" alt="post image">` : ""}
      <p>${post.content}</p>
      <div class="post-actions">
        <button class="like-btn ${isLiked ? 'liked' : ''}">${post.likes?.length || 0} ❤️</button>
        ${isOwner ? '<button class="delete-btn">Delete</button>' : ''}
      </div>
    `;

    // Like button
    const likeBtn = postDiv.querySelector(".like-btn");
    likeBtn.addEventListener("click",()=>{
      if(!currentUser){alert("Please sign in to like posts.");return;}
      toggleLike(post, currentUser);
      renderPosts();
    });

    // Delete button
    if(isOwner){
      const deleteBtn = postDiv.querySelector(".delete-btn");
      deleteBtn.addEventListener("click",()=>{
        if(confirm("Delete this post?")){
          deletePost(post);
          renderPosts();
        }
      });
    }

    postsContainer.appendChild(postDiv);
  });
}

submitPost.addEventListener("click",()=>{
  if(!postTitle.value.trim() || !postDescription.value.trim()) return alert("Please fill all fields.");
  const reader = new FileReader();
  reader.onload = function(e){
    addPost(currentUser, postTitle.value.trim(), postDescription.value.trim(), e.target.result);
    postTitle.value = "";
    postDescription.value = "";
    postImage.value = "";
    renderPosts();
  };
  if(postImage.files[0]) reader.readAsDataURL(postImage.files[0]);
  else {
    addPost(currentUser, postTitle.value.trim(), postDescription.value.trim(), null);
    renderPosts();
  }
});

renderPosts();
</script>
</body>
</html>
